#!/usr/bin/env php
<?php

declare(strict_types=1);

/**
 * PHPUnit Inline Tests CLI
 *
 * This is a drop-in replacement for PHPUnit that enables inline test discovery
 * while remaining fully backwards compatible with standard PHPUnit TestCases.
 *
 * Usage:
 *   vendor/bin/phpunit-inline [phpunit-options]
 *   vendor/bin/phpunit-inline --scan-directories=src,lib [phpunit-options]
 *
 * Configuration in phpunit.xml:
 *
 *   Option 1 - Using <inlineTests> element (recommended):
 *   <phpunit>
 *       <inlineTests>
 *           <directory>src</directory>
 *           <directory>app</directory>
 *       </inlineTests>
 *   </phpunit>
 *
 *   Option 2 - Using environment variable:
 *   <phpunit>
 *       <php>
 *           <env name="PHPUNIT_INLINE_SCAN_DIRECTORIES" value="src,app"/>
 *       </php>
 *   </phpunit>
 */

// Prevent direct execution without autoloader
if (!defined('STDIN')) {
    define('STDIN', fopen('php://stdin', 'r'));
}

// Find autoloader - but DON'T include it yet!
// We need to load our override files first.
$autoloadPaths = [
    // When installed as a dependency
    dirname(__DIR__, 4) . '/vendor/autoload.php',
    // When running from the package itself (development)
    dirname(__DIR__) . '/vendor/autoload.php',
];

$autoloadPath = null;

foreach ($autoloadPaths as $path) {
    if (file_exists($path)) {
        $autoloadPath = $path;
        break;
    }
}

if ($autoloadPath === null) {
    fwrite(STDERR, "Could not find autoloader. Did you run composer install?\n");
    exit(1);
}

// Determine the root path (where composer.json is)
$rootPath = dirname($autoloadPath, 2);

// Parse our custom arguments before passing to PHPUnit
$arguments = $_SERVER['argv'];
$scanDirectories = [];

// Remove script name
array_shift($arguments);

// Look for --scan-directories argument
$filteredArguments = [];

for ($i = 0; $i < count($arguments); $i++) {
    $arg = $arguments[$i];

    if (str_starts_with($arg, '--scan-directories=')) {
        $value = substr($arg, strlen('--scan-directories='));
        $scanDirectories = array_map('trim', explode(',', $value));
    } elseif ($arg === '--scan-directories') {
        // Value is in the next argument
        if (isset($arguments[$i + 1])) {
            $scanDirectories = array_map('trim', explode(',', $arguments[$i + 1]));
            $i++; // Skip next argument
        }
    } else {
        $filteredArguments[] = $arg;
    }
}

// If no scan directories provided via CLI, check phpunit.xml for configuration
if (empty($scanDirectories)) {
    $phpunitXmlPaths = [
        $rootPath . '/phpunit.xml',
        $rootPath . '/phpunit.xml.dist',
    ];

    foreach ($phpunitXmlPaths as $xmlPath) {
        if (file_exists($xmlPath)) {
            $xml = @simplexml_load_file($xmlPath);

            if ($xml !== false) {
                // Method 1 (recommended): Check for <inlineTests><directory> elements
                $inlineDirectories = $xml->xpath('//inlineTests/directory');
                if (!empty($inlineDirectories)) {
                    foreach ($inlineDirectories as $dir) {
                        $dirValue = trim((string) $dir);
                        if ($dirValue !== '') {
                            $scanDirectories[] = $dirValue;
                        }
                    }
                    if (!empty($scanDirectories)) {
                        break;
                    }
                }

                // Method 2: Check for PHPUNIT_INLINE_SCAN_DIRECTORIES env variable
                $envVars = $xml->xpath('//php/env[@name="PHPUNIT_INLINE_SCAN_DIRECTORIES"]');
                if (!empty($envVars)) {
                    $value = (string) $envVars[0]['value'];
                    $scanDirectories = array_map('trim', explode(',', $value));
                    break;
                }

                // Method 3: Check for legacy extension configuration (deprecated)
                $extensions = $xml->xpath('//extensions/bootstrap[contains(@class, "InlineTestExtension")]');
                if (!empty($extensions)) {
                    $parameters = $extensions[0]->xpath('parameter[@name="scanDirectories"]');
                    if (!empty($parameters)) {
                        $value = (string) $parameters[0]['value'];
                        $scanDirectories = array_map('trim', explode(',', $value));
                    }
                }
            }

            break;
        }
    }
}

// CRITICAL: Load our override files BEFORE the autoloader loads PHPUnit classes
// The order is:
// 1. Load our TestSuiteLoader override (defines PHPUnit\Runner\TestSuiteLoader)
// 2. Load composer autoloader (won't re-define our already-defined class)
// 3. Boot our kernel (initializes TestSuite singleton with scan directories)
// 4. Run PHPUnit (uses our TestSuiteLoader)

require_once dirname(__DIR__) . '/src/overrides/Runner/TestSuiteLoader.php';

// Now include the autoloader - our override class is already defined
require_once $autoloadPath;

// Boot the kernel with scan directories
\NSRosenqvist\PHPUnitInline\Kernel::boot($rootPath, $scanDirectories);

// Build PHPUnit arguments
// We want to be fully backwards compatible:
// 1. If user specifies paths/files, use those (standard PHPUnit behavior)
// 2. If no paths specified, use phpunit.xml testsuites AND scan directories
// 3. PHPUnit will still read phpunit.xml for other configuration

$phpunitArgs = ['phpunit'];

// Check if user already specified directories/files to test
$hasTestPath = false;
$hasConfig = false;

foreach ($filteredArguments as $arg) {
    // Skip options (arguments starting with -)
    if (!str_starts_with($arg, '-')) {
        $hasTestPath = true;
    }
    // Check if config is specified
    if (str_starts_with($arg, '--configuration') || str_starts_with($arg, '-c')) {
        $hasConfig = true;
    }
}

// If user specified explicit test paths, just pass through to PHPUnit
// (standard PHPUnit behavior - the user knows what they want to run)
if ($hasTestPath) {
    $phpunitArgs = array_merge($phpunitArgs, $filteredArguments);
} else {
    // No explicit test paths specified
    // We need to collect all test directories: from phpunit.xml + scan directories

    $testDirectories = [];
    $testFiles = [];

    // Parse phpunit.xml to get configured testsuites
    $phpunitXmlPaths = [
        $rootPath . '/phpunit.xml',
        $rootPath . '/phpunit.xml.dist',
    ];

    foreach ($phpunitXmlPaths as $xmlPath) {
        if (file_exists($xmlPath)) {
            $xml = @simplexml_load_file($xmlPath);

            if ($xml !== false) {
                // Get directories from testsuites
                $directories = $xml->xpath('//testsuites/testsuite/directory');
                foreach ($directories as $dir) {
                    $dirPath = (string) $dir;
                    $fullPath = str_starts_with($dirPath, '/') ? $dirPath : $rootPath . '/' . $dirPath;
                    if (is_dir($fullPath)) {
                        $testDirectories[] = $fullPath;
                    }
                }

                // Get files from testsuites
                $files = $xml->xpath('//testsuites/testsuite/file');
                foreach ($files as $file) {
                    $filePath = (string) $file;
                    $fullPath = str_starts_with($filePath, '/') ? $filePath : $rootPath . '/' . $filePath;
                    if (file_exists($fullPath)) {
                        $testFiles[] = $fullPath;
                    }
                }
            }

            break;
        }
    }

    // Add scan directories for inline tests
    foreach ($scanDirectories as $dir) {
        $fullPath = str_starts_with($dir, '/') ? $dir : $rootPath . '/' . $dir;
        if (is_dir($fullPath)) {
            $testDirectories[] = $fullPath;
        }
    }

    // If we have test paths (from config or scan dirs), add them
    if (!empty($testDirectories) || !empty($testFiles)) {
        $phpunitArgs = array_merge($phpunitArgs, $filteredArguments);

        // Add all directories
        foreach (array_unique($testDirectories) as $dir) {
            $phpunitArgs[] = $dir;
        }

        // Add all files
        foreach (array_unique($testFiles) as $file) {
            $phpunitArgs[] = $file;
        }

        // When scanning source directories for inline tests,
        // we need to look at all .php files, not just *Test.php
        if (!empty($scanDirectories)) {
            $phpunitArgs[] = '--test-suffix=.php';
        }
    } else {
        // No directories found, just pass through
        $phpunitArgs = array_merge($phpunitArgs, $filteredArguments);
    }
}

// Rebuild argv for PHPUnit
$_SERVER['argv'] = $phpunitArgs;
$_SERVER['argc'] = count($_SERVER['argv']);

// Run PHPUnit
$code = (new \PHPUnit\TextUI\Application())->run($_SERVER['argv']);

exit($code);
